<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DHL Men√∫ Semanal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --bg: #faf8f5;
      --card: #ffffff;
      --border: #e8e0d4;
      --primary: #D40511;
      --primary-light: #fff1f1;
      --primary-hover: #b30410;
      --yellow: #FFCC00;
      --yellow-light: #fff9e0;
      --text: #2d2d2d;
      --muted: #7a7268;
      --success: #16a34a;
      --success-light: #f0fdf4;
      --danger: #D40511;
      --accent: #D40511;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse at 10% 90%, rgba(255, 204, 0, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 90% 10%, rgba(212, 5, 17, 0.05) 0%, transparent 50%);
    }

    /* NAVEGACI√ìN */
    nav {
      background: #D40511;
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 58px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(212, 5, 17, 0.2);
    }

    .nav-logo {
      font-weight: 800;
      font-size: 1.05rem;
      color: #FFCC00;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      letter-spacing: -0.02em;
    }

    .nav-logo-mark {
      width: 88px;
      height: 20px;
      flex-shrink: 0;
      display: block;
    }

    .nav-tabs {
      display: flex;
      gap: 0.25rem;
    }

    .nav-tab {
      padding: 0.4rem 0.9rem;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.7);
      transition: all 0.2s;
    }

    .nav-tab:hover { background: rgba(255,255,255,0.15); color: #fff; }
    .nav-tab.activo { background: #FFCC00; color: #2d2d2d; }

    /* VISTAS */
    .vista { display: none; padding: 2rem 1rem 4rem; max-width: 700px; margin: 0 auto; }
    .vista.activa { display: block; }

    /* TIPOGRAF√çA */
    h2 {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 0.3rem;
      color: var(--primary);
    }

    .desc {
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 1.8rem;
      line-height: 1.5;
    }

    /* CARDS */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.4rem;
      margin-bottom: 1.2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .card-title {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    /* INPUTS */
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.3rem;
    }

    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 0.65rem 0.9rem;
      font-size: 0.88rem;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
      margin-bottom: 0.8rem;
    }

    input[type="text"]:focus { border-color: var(--yellow); box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.15); }

    .semana-input {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
      margin-bottom: 1.5rem;
    }

    .semana-input > div { flex: 1; }
    .semana-input input { margin-bottom: 0; }

    /* LISTA DE ITEMS */
    .items-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .item-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .item-row input { margin-bottom: 0; flex: 1; }

    .btn-icon {
      width: 34px;
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 7px;
      background: var(--card);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      color: var(--danger);
    }

    .btn-icon:hover { background: var(--primary-light); border-color: var(--danger); }

    .btn-agregar {
      background: none;
      border: 1.5px dashed var(--border);
      border-radius: 7px;
      padding: 0.6rem;
      width: 100%;
      font-size: 0.8rem;
      color: var(--muted);
      cursor: pointer;
      margin-top: 0.5rem;
      transition: all 0.2s;
    }

    .btn-agregar:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

    /* BOTONES */
    .btn {
      padding: 0.7rem 1.4rem;
      border-radius: 8px;
      font-size: 0.88rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #15803d; }
    .btn-outline { background: white; color: var(--text); border: 1px solid var(--border); }
    .btn-outline:hover { background: var(--bg); }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-full { width: 100%; justify-content: center; }

    /* LINK BOX */
    .link-box {
      background: var(--yellow-light);
      border: 1px solid #ffe580;
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-top: 1rem;
    }

    .link-text {
      flex: 1;
      font-size: 0.78rem;
      color: #92400e;
      word-break: break-all;
      font-family: monospace;
    }

    /* TABS DE D√çAS */
    .dia-tabs {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 1.2rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }

    .dia-tab {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border: 1.5px solid var(--border);
      background: white;
      color: var(--muted);
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .dia-tab:hover { border-color: var(--yellow); color: var(--text); background: var(--yellow-light); }
    .dia-tab.activo { background: var(--yellow); color: #2d2d2d; border-color: var(--yellow); font-weight: 700; }

    .dia-contenido { display: none; }
    .dia-contenido.activo { display: block; }

    /* FORMULARIO EMPLEADO */
    .opciones-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
    }

    .opcion-btn {
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      background: white;
      cursor: pointer;
      text-align: left;
      font-size: 0.82rem;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      transition: all 0.2s;
      line-height: 1.3;
    }

    .opcion-btn:hover { border-color: var(--yellow); background: var(--yellow-light); }
    .opcion-btn.seleccionado { border-color: var(--primary); background: var(--primary-light); color: var(--primary); font-weight: 600; }
    .opcion-btn.seleccionado::before { content: '‚úì '; }

    .nombre-aviso {
      margin-top: 0.7rem;
      padding: 0.7rem 0.8rem;
      border: 1px solid #ffe580;
      border-radius: 8px;
      background: var(--yellow-light);
      color: #7c5200;
      font-size: 0.78rem;
      line-height: 1.4;
      word-break: break-word;
    }

    .nombre-aviso strong {
      color: #6b4500;
      font-weight: 700;
    }

    /* SECCI√ìN D√çA EN FORMULARIO */
    .form-dia-section {
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1.2rem;
      overflow: hidden;
    }

    .form-dia-header {
      background: var(--yellow);
      padding: 0.8rem 1.2rem;
      font-weight: 700;
      font-size: 0.9rem;
      color: #2d2d2d;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .form-dia-body {
      padding: 1.2rem;
    }

    .form-dia-postre {
      font-size: 0.78rem;
      color: var(--muted);
      font-style: italic;
    }

    /* RESUMEN */
    .resumen-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1.2rem;
    }

    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .stat-num {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.72rem;
      color: var(--muted);
    }

    .bar-item {
      margin-bottom: 0.9rem;
    }

    .bar-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 0.3rem;
    }

    .bar-count {
      font-weight: 600;
      color: var(--primary);
    }

    .bar-track {
      height: 8px;
      background: var(--bg);
      border-radius: 999px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: var(--primary);
      transition: width 0.5s ease;
    }

    .bar-fill.bebida { background: var(--accent); }

    .personas-lista {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .persona-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.7rem 0.9rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.82rem;
    }

    .persona-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--yellow);
      color: #2d2d2d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .persona-nombre { font-weight: 600; flex: 1; }
    .persona-detalle { color: var(--muted); font-size: 0.75rem; text-align: right; }

    /* ESTADO VAC√çO */
    .empty {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #2d2d2d;
      color: var(--yellow);
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      z-index: 999;
      transition: transform 0.3s ease;
      white-space: nowrap;
    }

    .toast.visible { transform: translateX(-50%) translateY(0); }

    /* √âXITO */
    .success-box {
      background: var(--yellow-light);
      border: 1px solid #ffe580;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      display: none;
    }

    .success-box.visible { display: block; }
    .success-box h3 { font-size: 1.2rem; color: var(--primary); margin-bottom: 0.5rem; }
    .success-box p { font-size: 0.82rem; color: var(--text); }
    #ya-respondio-detalle { white-space: pre-line; }

    @media (max-width: 480px) {
      .opciones-grid { grid-template-columns: 1fr; }
      .resumen-grid { grid-template-columns: 1fr 1fr; }
      .nav-tab { padding: 0.4rem 0.6rem; font-size: 0.75rem; }
      .dia-tab { padding: 0.4rem 0.7rem; font-size: 0.75rem; }
      .nombre-aviso { font-size: 0.76rem; padding: 0.65rem 0.75rem; }
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-logo">
    <svg class="nav-logo-mark" viewBox="0 0 175.748 38.786" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <polygon fill="#FECC00" points="0,38.786 0,0 175.748,0 175.748,38.786"/>
      <path fill="#D50029" d="M56.665,16.206c-0.768,1.04-2.053,2.848-2.835,3.904c-0.397,0.537-1.114,1.512,1.263,1.512h12.515 c0,0,2.017-2.744,3.708-5.039c2.3-3.122,0.199-9.618-8.024-9.618H30.908l-5.615,7.629c0,0,29.109,0,30.603,0 C57.441,14.594,57.42,15.182,56.665,16.206z M47.471,23.504c-2.377,0-1.66-0.977-1.263-1.514c0.782-1.056,2.088-2.845,2.856-3.885 c0.756-1.024,0.776-1.612-0.771-1.612H34.297L23.02,31.819h27.501c9.083,0,14.14-6.178,15.699-8.314H47.471z M65.361,31.819h16.133 l6.116-8.316l-16.131,0.002L65.361,31.819z M106.986,6.965l-6.188,8.405h-7.2l6.185-8.405H83.655l-10.79,14.657h39.46 l10.787-14.657H106.986z M88.694,31.819h16.127l6.119-8.314H94.813L88.694,31.819z M0,26.784v1.766h22.468l1.298-1.766H0z M26.181,23.504H0v1.764h24.88L26.181,23.504z M0,31.819h20.061l1.292-1.756H0V31.819z M152.072,28.549h23.676v-1.766h-22.376 L152.072,28.549z M149.667,31.819h26.081v-1.756h-24.79L149.667,31.819z M155.783,23.504l-1.297,1.766h21.262v-1.766H155.783z M134.659,21.622l10.789-14.657h-17.081l-10.797,14.657H134.659z M116.187,23.504c0,0-1.179,1.611-1.752,2.387 c-2.025,2.736-0.234,5.928,6.376,5.928h25.901l6.119-8.314H116.187z"/>
    </svg>
    <span>Men√∫ Semanal</span>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab" id="tab-login" onclick="irA('login')" style="display:none">üîë Login</button>
    <button class="nav-tab" id="tab-admin" onclick="irA('admin')" style="display:none">‚öôÔ∏è Admin</button>
    <button class="nav-tab" id="tab-form" onclick="irA('form')">üìã Formulario</button>
    <button class="nav-tab" id="tab-resumen" onclick="irA('resumen')" style="display:none">üìä Resumen</button>
  </div>
</nav>

<!-- ======================== VISTA LOGIN ======================== -->
<div class="vista" id="vista-login">
  <div style="max-width:380px; margin:2rem auto;">
    <div style="text-align:center; margin-bottom:2rem;">
      <div style="font-size:2.5rem; margin-bottom:0.5rem;">üîê</div>
      <h2>Acceso administrador</h2>
      <p class="desc" style="margin-bottom:0">Ingres√° tus credenciales para gestionar el men√∫.</p>
    </div>
    <div class="card">
      <div class="card-title">üë§ Credenciales</div>
      <label>Usuario</label>
      <input type="text" id="login-usuario" placeholder="Tu usuario">
      <label>Contrase√±a</label>
      <input type="text" id="login-clave" placeholder="Tu contrase√±a" onkeydown="if(event.key==='Enter') loginAdmin()">
      <button class="btn btn-primary btn-full" onclick="loginAdmin()" style="margin-top:0.5rem">
        Ingresar ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- ======================== VISTA ADMIN ======================== -->
<div class="vista" id="vista-admin">
  <h2>Configurar men√∫</h2>
  <p class="desc">Configur√° las opciones de comida y postre para cada d√≠a. Las bebidas son fijas para toda la semana.</p>

  <div class="card">
    <div class="card-title">üìÖ Semana</div>
    <div class="semana-input">
      <div>
        <label>Desde</label>
        <input type="date" id="semana-desde" oninput="onDesdeInput()">
      </div>
      <div>
        <label>Hasta</label>
        <input type="date" id="semana-hasta">
      </div>
    </div>
    <div>
      <label>Fecha l√≠mite para tomar pedidos</label>
      <input type="datetime-local" id="semana-fecha-limite" style="margin-bottom:0">
      <p style="font-size:0.75rem; color:var(--muted); margin-top:0.45rem">Se sugiere el Viernes previo al mediod√≠a autom√°ticamente. <button type="button" onclick="sugerirFechaLimite()" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:0.75rem;padding:0;text-decoration:underline;">‚Ü∫ Recalcular</button></p>
    </div>
  </div>

  <div class="dia-tabs" id="admin-dia-tabs"></div>
  <div id="admin-dia-contenidos"></div>

  <button class="btn btn-primary btn-full" onclick="guardarMenu()" style="margin-top:0.5rem">
    Guardar y generar link ‚Üí
  </button>

  <div id="link-generado" style="display:none; margin-top:1rem;">
    <div class="link-box">
      <span class="link-text" id="link-texto"></span>
      <button class="btn btn-outline" onclick="copiarLink()" style="flex-shrink:0">Copiar</button>
    </div>
    <p style="font-size:0.75rem; color:var(--muted); margin-top:0.5rem; text-align:center">
      Compart√≠ este link con tu equipo. Las respuestas se guardan autom√°ticamente.
    </p>
  </div>
</div>

<!-- ======================== VISTA FORMULARIO ======================== -->
<div class="vista" id="vista-form">

  <div id="form-sin-menu" class="empty" style="display:none">
    <div class="empty-icon">‚ö†Ô∏è</div>
    <p>No hay un men√∫ configurado todav√≠a.<br>Pedile al admin que configure el men√∫ primero.</p>
  </div>

  <div id="form-cerrado" class="empty" style="display:none">
    <div class="empty-icon">üîí</div>
    <p id="form-cerrado-texto">Los pedidos para esta semana ya est√°n cerrados.</p>
  </div>

  <div id="form-contenido" style="display:none">
    <div style="margin-bottom:1.5rem">
      <div style="font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.25rem">Men√∫ de la semana</div>
      <h2 id="form-semana-titulo">‚Äî</h2>
    </div>

    <div id="form-deadline-aviso" style="display:none; background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:0.6rem 1rem; margin-bottom:1rem; font-size:0.85rem; color:#92400e;"></div>

    <div class="card">
      <div class="card-title">üè¢ ¬øA qu√© equipo pertenec√©s?</div>
      <div class="opciones-grid" id="opciones-grupo"></div>
    </div>

    <div class="card">
      <div class="card-title">üë§ Tu nombre</div>
      <input type="text" id="nombre-persona" placeholder="Ingres√° tu nombre y apellido">
      <div class="nombre-aviso">
        <strong>Importante:</strong> Ped√≠ tu men√∫ solo para los d√≠as en que tengas jornada laboral. Si tenes franco o vacaciones, recorda no pedir tu men√∫ para esos dias.
      </div>
    </div>

    <div id="form-dias-container"></div>

    <div id="ya-respondio" class="success-box" style="margin-bottom:1rem">
      <h3>‚úÖ Ya enviaste tu pedido</h3>
      <p id="ya-respondio-detalle"></p>
    </div>

    <button class="btn btn-success btn-full" id="btn-enviar" onclick="enviarPedido()">
      Confirmar pedido de la semana ‚úì
    </button>
  </div>

</div>

<!-- ======================== VISTA RESUMEN ======================== -->
<div class="vista" id="vista-resumen">

  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.3rem">
    <h2>Resumen semanal</h2>
    <button class="btn btn-outline" onclick="cargarResumen()" style="font-size:0.78rem; padding:0.4rem 0.8rem">‚Üª Actualizar</button>
  </div>
  <p class="desc" id="resumen-semana-titulo">Cargando...</p>

  <div style="margin-bottom:1.2rem">
    <div class="stat-card">
      <div class="stat-num" id="stat-total">‚Äî</div>
      <div class="stat-label">Respuestas recibidas</div>
    </div>
  </div>

  <div id="resumen-sin-datos" class="empty" style="display:none">
    <div class="empty-icon">üì≠</div>
    <p>Todav√≠a no hay respuestas.<br>Compart√≠ el formulario con tu equipo.</p>
  </div>

  <div id="resumen-datos" style="display:none">
    <div class="card" style="margin-bottom:1rem; padding:1rem;">
      <div style="display:flex; gap:0.6rem; flex-wrap:wrap; align-items:flex-end;">
        <div style="flex:1; min-width:220px;">
          <label for="resumen-filtro-equipo">Filtrar por equipo</label>
          <select id="resumen-filtro-equipo" onchange="onChangeResumenFiltroEquipo()" style="width:100%; border:1px solid var(--border); border-radius:7px; padding:0.65rem 0.9rem; font-size:0.88rem; font-family:'Inter', sans-serif; color:var(--text); background:#fff;">
            <option value="__TODOS__">Todos los equipos</option>
          </select>
        </div>
        <button class="btn btn-outline" onclick="exportarResumenCSV()" style="font-size:0.82rem; padding:0.6rem 1rem;">
          ‚¨á Exportar CSV semanal
        </button>
        <button class="btn btn-outline" onclick="cerrarSemana()" style="font-size:0.82rem; padding:0.6rem 1rem; color:var(--danger); border-color:var(--danger);">
          üîí Cerrar semana (sin borrar)
        </button>
      </div>
    </div>

    <div class="dia-tabs" id="resumen-dia-tabs"></div>

    <div id="resumen-postre" style="display:none; margin-bottom:1rem;">
      <div class="card" style="display:flex; align-items:center; gap:0.75rem; padding:1rem 1.4rem; border-left:3px solid #d97706;">
        <span style="font-size:1.4rem">üçÆ</span>
        <div>
          <div style="font-size:0.7rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em;">Postre del d√≠a</div>
          <div style="font-weight:600; font-size:0.95rem;" id="resumen-postre-texto"></div>
        </div>
      </div>
    </div>

    <div id="resumen-equipos"></div>

  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ========== CONSTANTES ==========
var DIAS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'Sabado', 'Domingo'];
var GRUPOS = [
  "HUB AM",
  "HUB PM",
  "COURIER AM",
  "COURIER PM",
  "FORMAL AM",
  "FORMAL PM",
  "AFORO AM",
  "AFORO PM",
  "DENUNCIAS",
  "SEGURIDAD"
];
var BEBIDAS_FIJAS = ["PEPSI", "PEPSI BLACK", "7UP", "7UP LIGHT", "PASO DE LOS TOROS", "MIRINDA", "JUGO POMELO", "JUGO MANZANA", "AGUA", "AGUA CON GAS"];
var ADMIN_USUARIO = 'gtwezeiza';
var ADMIN_CLAVE = 'operaciones2026';
// Sin l√≠mite de pedidos

// ========== SUPABASE CONFIG ==========
var SUPABASE_URL = 'https://ghxgamzvvgsootxxyeee.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoeGdhbXp2dmdzb290eHh5ZWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDQyMTQsImV4cCI6MjA4NzM4MDIxNH0.wem5mZntSR-BB82ivuQ3lYC4AJHxvD2s7x-zIVXJ2zQ';

var db = null;
try {
  db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch(e) {
  console.error('Error al inicializar Supabase:', e);
}

function getBebidasFijas() {
  return (BEBIDAS_FIJAS || []).map(b => String(b || '').trim()).filter(Boolean);
}

function normalizarTextoFecha(v) {
  return String(v || '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .trim();
}

function parseFechaBaseSemana(texto) {
  var raw = String(texto || '').trim();
  if (!raw) return null;

  var ymd = raw.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
  if (ymd) {
    var anioYmd = Number(ymd[1]);
    var mesYmd = Number(ymd[2]);
    var diaYmd = Number(ymd[3]);
    var fechaYmd = new Date(anioYmd, mesYmd - 1, diaYmd, 12, 0, 0, 0);
    if (fechaYmd.getFullYear() === anioYmd && (fechaYmd.getMonth() + 1) === mesYmd && fechaYmd.getDate() === diaYmd) return fechaYmd;
  }

  var dmy = raw.match(/^(\d{1,2})[-\/](\d{1,2})(?:[-\/](\d{2,4}))?$/);
  if (dmy) {
    var diaDmy = Number(dmy[1]);
    var mesDmy = Number(dmy[2]);
    var anioDmy = dmy[3] ? Number(dmy[3]) : new Date().getFullYear();
    if (anioDmy < 100) anioDmy += 2000;
    var fechaDmy = new Date(anioDmy, mesDmy - 1, diaDmy, 12, 0, 0, 0);
    if (fechaDmy.getFullYear() === anioDmy && (fechaDmy.getMonth() + 1) === mesDmy && fechaDmy.getDate() === diaDmy) return fechaDmy;
  }

  var meses = {
    enero: 1, febrero: 2, marzo: 3, abril: 4, mayo: 5, junio: 6,
    julio: 7, agosto: 8, septiembre: 9, setiembre: 9, octubre: 10, noviembre: 11, diciembre: 12
  };
  var norm = normalizarTextoFecha(raw);
  var matchMes = norm.match(/^(\d{1,2})\s+de\s+([a-z]+)(?:\s+de\s+(\d{4}))?$/);
  if (matchMes) {
    var diaMes = Number(matchMes[1]);
    var mesNombre = matchMes[2];
    var nroMes = meses[mesNombre];
    var anioMes = matchMes[3] ? Number(matchMes[3]) : new Date().getFullYear();
    if (nroMes) {
      var fechaMes = new Date(anioMes, nroMes - 1, diaMes, 12, 0, 0, 0);
      if (fechaMes.getFullYear() === anioMes && (fechaMes.getMonth() + 1) === nroMes && fechaMes.getDate() === diaMes) return fechaMes;
    }
  }

  return null;
}

function getEtiquetaDia(nombreDia, fechaDesdeTexto, idxOpcional) {
  var idx = typeof idxOpcional === 'number' ? idxOpcional : DIAS.indexOf(nombreDia);
  if (idx < 0) return nombreDia;

  var base = parseFechaBaseSemana(fechaDesdeTexto);
  if (!base) return nombreDia;

  var fechaDia = new Date(base.getTime());
  fechaDia.setDate(fechaDia.getDate() + idx);
  return nombreDia + ' ' + fechaDia.getDate() + '-' + (fechaDia.getMonth() + 1);
}

function toDateTimeLocalValue(valor) {
  if (!valor) return '';
  var d = new Date(valor);
  if (isNaN(d.getTime())) return '';
  var pad = function(n) { return String(n).padStart(2, '0'); };
  return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
}

function parseDateTimeLocalToISO(valor) {
  var raw = String(valor || '').trim();
  if (!raw) return null;
  var d = new Date(raw);
  if (isNaN(d.getTime())) return null;
  return d.toISOString();
}

function toDateValue(texto) {
  var d = parseFechaBaseSemana(String(texto || '').trim());
  if (!d) return '';
  var pad = function(n) { return String(n).padStart(2, '0'); };
  return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
}

function formatarFechaCorta(texto) {
  var d = parseFechaBaseSemana(String(texto || '').trim());
  if (!d) return texto;
  return d.getDate() + '/' + (d.getMonth() + 1);
}

function calcularFechaLimiteSugerida(desdeTexto) {
  var base = parseFechaBaseSemana(desdeTexto);
  if (!base) return null;
  var dow = base.getDay(); // 0=Dom, 1=Lun, ..., 5=Vie, 6=Sab
  var diasAViernes = ((dow - 5 + 7) % 7) || 7; // 0 si Vie ‚Üí va 7 d√≠as atr√°s
  var viernes = new Date(base.getTime());
  viernes.setDate(viernes.getDate() - diasAViernes);
  viernes.setHours(12, 0, 0, 0);
  return viernes;
}

function getDayNameFromDate(fecha) {
  var idx = fecha.getDay(); // 0 domingo ... 6 sabado
  var map = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'Sabado'];
  return map[idx] || null;
}

function getDiasOrdenadosPorDesde(diasNormalizados, desdeTexto) {
  var base = parseFechaBaseSemana(desdeTexto);
  if (!base) return diasNormalizados.slice();

  var nombreInicio = getDayNameFromDate(base);
  if (!nombreInicio) return diasNormalizados.slice();

  var idxInicio = DIAS.indexOf(nombreInicio);
  if (idxInicio < 0) return diasNormalizados.slice();

  var orden = DIAS.slice(idxInicio).concat(DIAS.slice(0, idxInicio));
  var porNombre = {};
  for (var i = 0; i < diasNormalizados.length; i++) porNombre[diasNormalizados[i].nombre] = diasNormalizados[i];

  var salida = [];
  for (var j = 0; j < orden.length; j++) {
    var n = orden[j];
    if (porNombre[n]) salida.push(porNombre[n]);
  }
  return salida;
}

var soporteCierreMenu = null;
async function detectarSoporteCierreMenu(forzar) {
  if (forzar === true) soporteCierreMenu = null;
  if (soporteCierreMenu === true) return true;
  if (!db) { soporteCierreMenu = false; return soporteCierreMenu; }
  const { error } = await db.from('menu').select('id,fecha_limite,cerrado').limit(1);
  if (!error) {
    soporteCierreMenu = true;
    return true;
  }
  if (error && error.code === '42703') {
    soporteCierreMenu = false;
    console.warn('Sin columnas de cierre en menu. Ejecut√° el SQL de actualizaci√≥n.', error);
    return false;
  }
  // No cachear falso por errores transitorios/red.
  console.warn('No se pudo validar soporte de cierre en este intento.', error);
  return false;
}

function menuEstaCerrado(menu) {
  if (!menu) return true;
  if (menu.cerrado === true) return true;
  if (!menu.fecha_limite) return false;
  var limite = new Date(menu.fecha_limite);
  if (isNaN(limite.getTime())) return false;
  return Date.now() > limite.getTime();
}

function descripcionCierreMenu(menu) {
  if (!menu) return 'No hay men√∫ activo.';
  if (menu.cerrado === true) return 'Los pedidos de esta semana est√°n cerrados por administraci√≥n.';
  if (menu.fecha_limite) {
    var limite = new Date(menu.fecha_limite);
    if (!isNaN(limite.getTime()) && Date.now() > limite.getTime()) {
      return 'La fecha l√≠mite de pedidos ya venci√≥ (' + limite.toLocaleString('es-AR') + ').';
    }
  }
  return '';
}

function leerMetaCierreDesdeDias(dias) {
  if (!Array.isArray(dias)) return null;
  for (var i = 0; i < dias.length; i++) {
    var d = dias[i];
    if (!d || typeof d !== 'object') continue;
    var meta = d._meta_cierre;
    if (!meta || typeof meta !== 'object') continue;
    return {
      fecha_limite: meta.fecha_limite ? String(meta.fecha_limite) : null,
      cerrado: !!meta.cerrado
    };
  }
  return null;
}

function inyectarMetaCierreEnDias(dias, fechaLimiteISO, cerrado) {
  var base = Array.isArray(dias) ? dias : [];
  if (base.length === 0) return [];

  var copia = base.map(function(d) {
    if (!d || typeof d !== 'object') return d;
    var out = Object.assign({}, d);
    if (Object.prototype.hasOwnProperty.call(out, '_meta_cierre')) delete out._meta_cierre;
    return out;
  });

  if (!copia[0] || typeof copia[0] !== 'object') copia[0] = { nombre: 'Lunes', comidas: [], bebidas: [], postre: '' };
  copia[0]._meta_cierre = {
    fecha_limite: fechaLimiteISO || null,
    cerrado: !!cerrado
  };
  return copia;
}

async function saveMenuMetaFallback(menuId, fechaLimiteISO, cerrado) {
  if (!db || !menuId) return false;
  const { data: actual, error: readError } = await db
    .from('menu')
    .select('id,dias')
    .eq('id', menuId)
    .maybeSingle();
  if (readError || !actual) { console.error('Error al leer menu para meta fallback:', readError); return false; }

  var diasActualizados = inyectarMetaCierreEnDias(actual.dias, fechaLimiteISO, cerrado);
  const { data: updated, error: updateError } = await db
    .from('menu')
    .update({ dias: diasActualizados })
    .eq('id', menuId)
    .select()
    .single();
  if (updateError) { console.error('Error al guardar meta de cierre en dias (fallback):', updateError); return false; }

  if (menuActivo && menuActivo.id === menuId) {
    menuActivo = updated;
    menuActivo.fecha_limite = fechaLimiteISO || null;
    menuActivo.cerrado = !!cerrado;
  }
  return true;
}

async function aplicarMetaCierreFallback(menu) {
  if (!menu) return menu;
  var tieneSoporteColumnas = await detectarSoporteCierreMenu();
  if (tieneSoporteColumnas) return menu;
  var meta = leerMetaCierreDesdeDias(menu.dias);
  menu.fecha_limite = meta ? meta.fecha_limite : null;
  menu.cerrado = meta ? !!meta.cerrado : false;
  return menu;
}

// ========== SUPABASE HELPERS ==========
var menuActivo = null;

async function getMenu() {
  if (!db) return null;
  const { data, error } = await db
    .from('menu')
    .select('*')
    .order('creado', { ascending: false })
    .limit(1)
    .maybeSingle();
  if (error) { console.error('Error al obtener men√∫:', error); return null; }
  menuActivo = data;
  await aplicarMetaCierreFallback(menuActivo);
  return menuActivo;
}

async function saveMenu(menu) {
  if (!db) { console.error('Supabase no inicializado'); return null; }

  // Si es la misma semana, actualizar el men√∫ actual para conservar el menu_id
  // y no separar respuestas en registros distintos.
  if (menuActivo && menuActivo.id && menuActivo.desde === menu.desde && menuActivo.hasta === menu.hasta) {
    const { data: updated, error: updateError } = await db
      .from('menu')
      .update(menu)
      .eq('id', menuActivo.id)
      .select()
      .single();
    if (updateError) { console.error('Error al actualizar men√∫:', updateError); return null; }
    menuActivo = updated;
    return updated;
  }

  // Si cambi√≥ la semana, crear un nuevo men√∫.
  const { data: inserted, error: insertError } = await db
    .from('menu')
    .insert(menu)
    .select()
    .single();
  if (insertError) { console.error('Error al guardar men√∫:', insertError); return null; }
  menuActivo = inserted;
  return inserted;
}

async function getRespuestas(menuId) {
  if (!db) return [];
  const { data, error } = await db
    .from('respuestas')
    .select('*')
    .eq('menu_id', menuId);
  if (error) { console.error('Error al obtener respuestas:', error); return []; }
  return data || [];
}

function mergePedidos(pedidosBase, pedidosNuevos) {
  var porDia = {};
  var i = 0;
  var prev = null;
  var nuevo = null;

  pedidosBase = Array.isArray(pedidosBase) ? pedidosBase : [];
  pedidosNuevos = Array.isArray(pedidosNuevos) ? pedidosNuevos : [];

  for (i = 0; i < pedidosBase.length; i++) {
    prev = pedidosBase[i];
    if (prev && prev.dia) porDia[prev.dia] = prev;
  }

  for (i = 0; i < pedidosNuevos.length; i++) {
    nuevo = pedidosNuevos[i];
    if (nuevo && nuevo.dia) porDia[nuevo.dia] = nuevo;
  }

  var pedidosMerge = [];
  var diasAgregados = {};

  if (menuActivo && Array.isArray(menuActivo.dias)) {
    for (i = 0; i < menuActivo.dias.length; i++) {
      var nombreDia = menuActivo.dias[i].nombre;
      if (porDia[nombreDia]) {
        pedidosMerge.push(porDia[nombreDia]);
        diasAgregados[nombreDia] = true;
      }
    }
  }

  for (var diaNombre in porDia) {
    if (!Object.prototype.hasOwnProperty.call(porDia, diaNombre)) continue;
    if (!diasAgregados[diaNombre]) pedidosMerge.push(porDia[diaNombre]);
  }

  return pedidosMerge;
}

function pedidosIguales(pedidosA, pedidosB) {
  var normalA = mergePedidos([], pedidosA).map(function(p) {
    return { dia: String(p.dia || ''), comida: String(p.comida || ''), bebida: String(p.bebida || '') };
  });
  var normalB = mergePedidos([], pedidosB).map(function(p) {
    return { dia: String(p.dia || ''), comida: String(p.comida || ''), bebida: String(p.bebida || '') };
  });
  return JSON.stringify(normalA) === JSON.stringify(normalB);
}

async function saveRespuesta(respuesta) {
  if (!db) { console.error('Supabase no inicializado'); return false; }
  const { data: existentes, error: existentesError } = await db
    .from('respuestas')
    .select('id,grupo,pedidos')
    .ilike('nombre', respuesta.nombre)
    .eq('menu_id', respuesta.menu_id)
    .order('id', { ascending: true });
  if (existentesError) { console.error('Error al consultar respuestas existentes:', existentesError); return false; }

  if (existentes && existentes.length > 0) {
    var base = existentes[0];
    var pedidosMergeExistentes = Array.isArray(base.pedidos) ? base.pedidos : [];

    for (var i = 1; i < existentes.length; i++) {
      pedidosMergeExistentes = mergePedidos(pedidosMergeExistentes, existentes[i].pedidos);
    }

    var pedidosMergeFinal = mergePedidos(pedidosMergeExistentes, respuesta.pedidos);
    var respuestaMerge = Object.assign({}, respuesta, { pedidos: pedidosMergeFinal });
    var mismoGrupo = String(base.grupo || '') === String(respuestaMerge.grupo || '');
    var mismosPedidos = pedidosIguales(base.pedidos, pedidosMergeFinal);

    if (!mismoGrupo || !mismosPedidos) {
      const { error: updateError } = await db.from('respuestas').update(respuestaMerge).eq('id', base.id);
      if (updateError) { console.error('Error al actualizar respuesta:', updateError); return false; }
    }

    if (existentes.length > 1) {
      var idsDuplicados = existentes.slice(1).map(function(r) { return r.id; }).filter(Boolean);
      if (idsDuplicados.length > 0) {
        const { error: deleteDupError } = await db.from('respuestas').delete().in('id', idsDuplicados);
        if (deleteDupError) { console.error('Error al limpiar respuestas duplicadas:', deleteDupError); }
      }
    }
  } else {
    const { error: insertError } = await db.from('respuestas').insert(respuesta);
    if (insertError) { console.error('Error al guardar respuesta:', insertError); return false; }

    // Mitiga doble click/race conditions: consolida por nombre + menu_id y deja 1 solo registro.
    const { data: repetidos, error: repetidosError } = await db
      .from('respuestas')
      .select('id,grupo,pedidos')
      .ilike('nombre', respuesta.nombre)
      .eq('menu_id', respuesta.menu_id)
      .order('id', { ascending: true });

    if (!repetidosError && repetidos && repetidos.length > 1) {
      var canonico = repetidos[0];
      var pedidosConsolidados = Array.isArray(canonico.pedidos) ? canonico.pedidos : [];
      for (var j = 1; j < repetidos.length; j++) {
        pedidosConsolidados = mergePedidos(pedidosConsolidados, repetidos[j].pedidos);
      }

      var respuestaConsolidada = Object.assign({}, respuesta, { pedidos: pedidosConsolidados });
      const { error: updateCanonicoError } = await db.from('respuestas').update(respuestaConsolidada).eq('id', canonico.id);
      if (updateCanonicoError) { console.error('Error al consolidar respuestas duplicadas:', updateCanonicoError); return false; }

      var idsSobran = repetidos.slice(1).map(function(r) { return r.id; }).filter(Boolean);
      if (idsSobran.length > 0) {
        const { error: deleteSobranError } = await db.from('respuestas').delete().in('id', idsSobran);
        if (deleteSobranError) { console.error('Error al eliminar respuestas duplicadas:', deleteSobranError); }
      }
    }
  }
  return true;
}

async function deleteRespuestas(menuId) {
  if (!db) return;
  const { error } = await db.from('respuestas').delete().eq('menu_id', menuId);
  if (error) console.error('Error al eliminar respuestas:', error);
}

// ========== AUTENTICACI√ìN ==========
var esAdmin = false;

async function verificarAdmin(usuario, clave) {
  return usuario === ADMIN_USUARIO && clave === ADMIN_CLAVE;
}

async function loginAdmin() {
  var usuario = document.getElementById('login-usuario').value.trim();
  var clave = document.getElementById('login-clave').value.trim();
  if (!usuario || !clave) { toast('‚ö†Ô∏è Ingres√° usuario y contrase√±a'); return; }

  var ok = await verificarAdmin(usuario, clave);
  if (!ok) { toast('‚ùå Usuario o contrase√±a incorrectos'); return; }

  esAdmin = true;
  document.getElementById('tab-admin').style.display = '';
  document.getElementById('tab-resumen').style.display = '';
  document.getElementById('tab-login').style.display = 'none';
  toast('‚úÖ Bienvenido, ' + usuario);
  await cargarMenuEnAdmin();
  irA('admin');
}

// ========== NAVEGACI√ìN ==========
function irA(vista) {
  // Proteger vistas de admin
  if ((vista === 'admin' || vista === 'resumen') && !esAdmin) {
    irA('login');
    return;
  }

  document.querySelectorAll('.vista').forEach(v => v.classList.remove('activa'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('activo'));
  document.getElementById('vista-' + vista).classList.add('activa');
  var tab = document.getElementById('tab-' + vista);
  if (tab) tab.classList.add('activo');
  if (vista === 'form') cargarFormulario();
  if (vista === 'resumen') cargarResumen();
}

// ========== TOAST ==========
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('visible');
  setTimeout(() => el.classList.remove('visible'), 2500);
}

// ========== ADMIN ==========
var menuDias = DIAS.map(d => ({ nombre: d, comidas: [], bebidas: getBebidasFijas(), postre: '' }));
var adminDiaActivo = 0;

function onDesdeInput() {
  renderAdminTabs();
  // Auto-sugerir Viernes al mediod√≠a solo cuando el admin escribe (no al cargar men√∫)
  var desdeSemana = (document.getElementById('semana-desde') || {}).value || '';
  var campoFechaLimite = document.getElementById('semana-fecha-limite');
  if (campoFechaLimite && !campoFechaLimite.value && desdeSemana) {
    var sugerida = calcularFechaLimiteSugerida(desdeSemana);
    if (sugerida) campoFechaLimite.value = toDateTimeLocalValue(sugerida);
  }
}

function renderAdminTabs() {
  const tabsEl = document.getElementById('admin-dia-tabs');
  const contEl = document.getElementById('admin-dia-contenidos');
  const desdeSemana = (document.getElementById('semana-desde') || {}).value || '';

  tabsEl.innerHTML = '';
  contEl.innerHTML = '';

  DIAS.forEach((dia, i) => {
    var etiquetaDia = getEtiquetaDia(dia, desdeSemana);
    // Tab
    const tab = document.createElement('button');
    tab.className = 'dia-tab' + (i === adminDiaActivo ? ' activo' : '');
    tab.textContent = etiquetaDia;
    tab.onclick = () => { adminDiaActivo = i; renderAdminTabs(); };
    tabsEl.appendChild(tab);

    // Contenido
    const div = document.createElement('div');
    div.className = 'dia-contenido' + (i === adminDiaActivo ? ' activo' : '');
    div.innerHTML = `
      <div class="card">
        <div class="card-title">üçõ Comidas ‚Äî ${etiquetaDia} <span style="color:var(--muted);font-weight:400">${menuDias[i].comidas.length > 0 ? '(' + menuDias[i].comidas.length + ')' : ''}</span></div>
        <div class="items-grid" id="admin-comidas-${i}"></div>
        <button class="btn-agregar" onclick="adminAgregarItem(${i}, 'comidas')">+ Agregar comida</button>
      </div>
      <div class="card">
        <div class="card-title">ü•§ Bebidas ‚Äî Fijas</div>
        <div style="display:flex; flex-wrap:wrap; gap:0.35rem">
          ${getBebidasFijas().map(b => `<span style="background:var(--primary-light); color:var(--primary); padding:4px 10px; border-radius:999px; font-size:0.75rem; border:1px solid #fca5a5">${b}</span>`).join('')}
        </div>
        <p style="font-size:0.75rem; color:var(--muted); margin-top:0.6rem">Estas bebidas se aplican autom√°ticamente a todos los d√≠as del men√∫.</p>
      </div>
      <div class="card">
        <div class="card-title">üçÆ Postre ‚Äî ${etiquetaDia}</div>
        <input type="text" value="${menuDias[i].postre}" placeholder="Ej: Flan con dulce de leche"
          oninput="menuDias[${i}].postre = this.value">
        <p style="font-size:0.75rem; color:var(--muted); margin-top:-0.4rem">Se muestra como informaci√≥n, no se elige.</p>
      </div>
    `;
    contEl.appendChild(div);

    // Render items si est√° activo
    if (i === adminDiaActivo) {
      setTimeout(() => {
        renderAdminItems(i, 'comidas');
      }, 0);
    }
  });
}

function renderAdminItems(diaIdx, tipo) {
  const grid = document.getElementById(`admin-${tipo}-${diaIdx}`);
  if (!grid) return;
  const items = menuDias[diaIdx][tipo];
  grid.innerHTML = '';

  items.forEach((item, j) => {
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
      <input type="text" value="${item}" placeholder="Nombre de la opci√≥n"
        oninput="menuDias[${diaIdx}].${tipo}[${j}] = this.value">
      <button class="btn-icon" onclick="adminEliminarItem(${diaIdx}, '${tipo}', ${j})">‚úï</button>
    `;
    grid.appendChild(row);
  });
}

function adminAgregarItem(diaIdx, tipo) {
  menuDias[diaIdx][tipo].push('');
  renderAdminTabs();
  setTimeout(() => {
    const inputs = document.querySelectorAll(`#admin-${tipo}-${diaIdx} input`);
    if (inputs.length) inputs[inputs.length - 1].focus();
  }, 10);
}

function adminEliminarItem(diaIdx, tipo, itemIdx) {
  menuDias[diaIdx][tipo].splice(itemIdx, 1);
  renderAdminTabs();
}

async function guardarMenu() {
  const desde = document.getElementById('semana-desde').value.trim();
  const hasta = document.getElementById('semana-hasta').value.trim();
  const fechaLimiteInput = document.getElementById('semana-fecha-limite').value;
  const bebidasFijas = getBebidasFijas();

  if (!desde || !hasta) { toast('‚ö†Ô∏è Ingres√° las fechas de la semana'); return; }
  if (bebidasFijas.length < 1) { toast('‚ö†Ô∏è Configur√° al menos una bebida fija'); return; }
  var fechaLimiteISO = parseDateTimeLocalToISO(fechaLimiteInput);
  if (fechaLimiteInput && !fechaLimiteISO) { toast('‚ö†Ô∏è Fecha l√≠mite inv√°lida'); return; }

  // Normalizar y permitir d√≠as vac√≠os (ej. s√°bado/domingo a√∫n no definidos).
  // Se guarda √∫nicamente lo que tenga al menos una comida para evitar d√≠as "vac√≠os" en el formulario.
  var diasNormalizados = menuDias.map(function(d) {
    var comidas = (Array.isArray(d.comidas) ? d.comidas : [])
      .map(function(x) { return (x == null ? '' : String(x)).trim(); })
      .filter(function(x) { return !!x; });
    return {
      nombre: d.nombre,
      comidas: comidas,
      bebidas: [].concat(bebidasFijas),
      postre: (d.postre == null ? '' : String(d.postre)).trim()
    };
  });

  var diasConComida = diasNormalizados.filter(function(d) { return d.comidas.length > 0; }).length;
  if (diasConComida < 1) { toast('‚ö†Ô∏è Carg√° al menos una comida en alg√∫n d√≠a'); return; }

  var dias = diasNormalizados.filter(function(d) { return d.comidas.length > 0; });
  dias = getDiasOrdenadosPorDesde(dias, desde);

  var menu = { desde: desde, hasta: hasta, dias: dias, creado: Date.now() };
  var tieneCierre = await detectarSoporteCierreMenu(true);
  if (tieneCierre) {
    menu.fecha_limite = fechaLimiteISO;
    menu.cerrado = false;
  } else {
    menu.dias = inyectarMetaCierreEnDias(menu.dias, fechaLimiteISO, false);
  }
  const saved = await saveMenu(menu);
  if (!saved) { toast('‚ùå Error al guardar el men√∫'); return; }

  if (!tieneCierre) {
    saved.fecha_limite = fechaLimiteISO;
    saved.cerrado = false;
    menuActivo = saved;
  }

  const link = window.location.href.split('?')[0] + '?vista=form';
  document.getElementById('link-texto').textContent = link;
  document.getElementById('link-generado').style.display = 'block';
  toast('‚úÖ Men√∫ guardado correctamente');
}

function copiarLink() {
  const link = document.getElementById('link-texto').textContent;
  navigator.clipboard.writeText(link).then(() => toast('‚úÖ Link copiado'));
}

function sugerirFechaLimite() {
  var desdeSemana = (document.getElementById('semana-desde') || {}).value || '';
  var campoFechaLimite = document.getElementById('semana-fecha-limite');
  if (!campoFechaLimite) return;
  var sugerida = calcularFechaLimiteSugerida(desdeSemana);
  if (sugerida) {
    campoFechaLimite.value = toDateTimeLocalValue(sugerida);
  } else {
    toast('‚ö†Ô∏è Ingres√° primero la fecha de inicio de la semana');
  }
}

// ========== FORMULARIO ==========
var grupoSeleccionado = null;
var pedidosPorDia = {}; // { "Lunes": { comida: "...", bebida: "..." }, ... }
var envioEnCurso = false;
var TEXTO_BTN_ENVIAR = 'Confirmar pedido de la semana ‚úì';

async function cargarFormulario() {
  const menu = await getMenu();

  if (!menu) {
    document.getElementById('form-sin-menu').style.display = 'block';
    document.getElementById('form-cerrado').style.display = 'none';
    document.getElementById('form-contenido').style.display = 'none';
    return;
  }

  document.getElementById('form-sin-menu').style.display = 'none';
  if (menuEstaCerrado(menu)) {
    document.getElementById('form-cerrado').style.display = 'block';
    document.getElementById('form-cerrado-texto').textContent = descripcionCierreMenu(menu) || 'Los pedidos de esta semana ya est√°n cerrados.';
    document.getElementById('form-contenido').style.display = 'none';
    return;
  }
  document.getElementById('form-cerrado').style.display = 'none';
  document.getElementById('form-contenido').style.display = 'block';
  document.getElementById('form-semana-titulo').textContent =
    `Semana del ${formatarFechaCorta(menu.desde)} al ${formatarFechaCorta(menu.hasta)}`;

  var avisoDl = document.getElementById('form-deadline-aviso');
  if (avisoDl) {
    if (menu.fecha_limite) {
      var limiteFut = new Date(menu.fecha_limite);
      if (!isNaN(limiteFut.getTime()) && Date.now() <= limiteFut.getTime()) {
        avisoDl.textContent = '‚è∞ Pod√©s hacer tu pedido hasta el ' +
          limiteFut.toLocaleString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
        avisoDl.style.display = 'block';
      } else {
        avisoDl.style.display = 'none';
      }
    } else {
      avisoDl.style.display = 'none';
    }
  }

  // Grupos
  const gg = document.getElementById('opciones-grupo');
  gg.innerHTML = '';
  GRUPOS.forEach(g => {
    const btn = document.createElement('button');
    btn.className = 'opcion-btn';
    btn.textContent = g;
    btn.onclick = () => { grupoSeleccionado = g; resaltarOpcion(gg, btn); };
    gg.appendChild(btn);
  });

  // D√≠as
  pedidosPorDia = {};
  const container = document.getElementById('form-dias-container');
  container.innerHTML = '';

  menu.dias.forEach(function(dia, idxDia) {
    var etiquetaDia = getEtiquetaDia(dia.nombre, menu.desde, idxDia);
    pedidosPorDia[dia.nombre] = { comida: null, bebida: null };
    var comidasDia = (Array.isArray(dia.comidas) ? dia.comidas : []).filter(function(x) { return x && String(x).trim(); });
    var bebidasDia = (Array.isArray(dia.bebidas) ? dia.bebidas : []).filter(function(x) { return x && String(x).trim(); });
    var tieneComidas = comidasDia.length > 0;

    const section = document.createElement('div');
    section.className = 'form-dia-section';

    let postreHTML = '';
    if (dia.postre) {
      postreHTML = `<div class="form-dia-postre">üçÆ Postre: ${dia.postre}</div>`;
    }

    section.innerHTML = `
      <div class="form-dia-header">
        <span>üìÖ ${etiquetaDia}</span>
        ${postreHTML}
      </div>
      <div class="form-dia-body">
        ${tieneComidas ? `
          <div style="margin-bottom:1rem">
            <div class="card-title" style="margin-bottom:0.6rem">üçõ Comida</div>
            <div class="opciones-grid" id="form-comida-${dia.nombre}"></div>
          </div>
          <div>
            <div class="card-title" style="margin-bottom:0.6rem">ü•§ Bebida</div>
            <div class="opciones-grid" id="form-bebida-${dia.nombre}"></div>
          </div>
        ` : `
          <div style="color:var(--muted); font-size:0.86rem;">Sin menu cargado para este dia.</div>
        `}
      </div>
    `;
    container.appendChild(section);

    if (!tieneComidas) return;

    // Render opciones comida
    setTimeout(() => {
      const gc = document.getElementById(`form-comida-${dia.nombre}`);
      comidasDia.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'opcion-btn';
        btn.type = 'button';
        btn.textContent = c;
        btn.onclick = () => {
          toggleOpcion(
            gc,
            btn,
            pedidosPorDia[dia.nombre].comida,
            function() { pedidosPorDia[dia.nombre].comida = c; },
            function() { pedidosPorDia[dia.nombre].comida = null; }
          );
        };
        gc.appendChild(btn);
      });

      const gb = document.getElementById(`form-bebida-${dia.nombre}`);
      bebidasDia.forEach(b => {
        const btn = document.createElement('button');
        btn.className = 'opcion-btn';
        btn.type = 'button';
        btn.textContent = b;
        btn.onclick = () => {
          toggleOpcion(
            gb,
            btn,
            pedidosPorDia[dia.nombre].bebida,
            function() { pedidosPorDia[dia.nombre].bebida = b; },
            function() { pedidosPorDia[dia.nombre].bebida = null; }
          );
        };
        gb.appendChild(btn);
      });
    }, 0);
  });

  grupoSeleccionado = null;
  document.getElementById('nombre-persona').value = '';
  document.getElementById('ya-respondio').classList.remove('visible');
  var btnEnviar = document.getElementById('btn-enviar');
  if (btnEnviar) {
    btnEnviar.style.display = 'flex';
    btnEnviar.disabled = false;
    btnEnviar.textContent = TEXTO_BTN_ENVIAR;
  }
}

function resaltarOpcion(grid, btnActivo) {
  grid.querySelectorAll('.opcion-btn').forEach(b => b.classList.remove('seleccionado'));
  btnActivo.classList.add('seleccionado');
}

function toggleOpcion(grid, btn, valorActual, onSelect, onClear) {
  if (valorActual && btn.textContent === valorActual) {
    if (typeof onClear === 'function') onClear();
    btn.classList.remove('seleccionado');
    return;
  }
  if (typeof onSelect === 'function') onSelect();
  resaltarOpcion(grid, btn);
}

// ========== FORMULARIO ==========
// Permite d√≠as sin pedido (franco/vacaciones) con validaci√≥n de pares comida+bebida.
async function enviarPedido() {
  var nombre = document.getElementById('nombre-persona').value.trim();
  var btnEnviar = document.getElementById('btn-enviar');
  var textoBotonOriginal = btnEnviar ? btnEnviar.textContent : TEXTO_BTN_ENVIAR;
  var envioExitoso = false;

  if (envioEnCurso) { toast('‚è≥ Tu pedido se est√° enviando...'); return; }
  if (!grupoSeleccionado) { toast('‚ö†Ô∏è Eleg√≠ tu equipo primero'); return; }
  if (!nombre) { toast('‚ö†Ô∏è Ingres√° tu nombre'); return; }
  if (!menuActivo) { toast('‚ùå No hay men√∫ activo'); return; }
  if (menuEstaCerrado(menuActivo)) { toast('üîí Los pedidos de esta semana est√°n cerrados'); return; }

  var pedidos = [];
  var diasSinPedido = [];

  for (var i = 0; i < menuActivo.dias.length; i++) {
    var dia = menuActivo.dias[i];
    var p = pedidosPorDia[dia.nombre] || {};
    var tieneComida = !!p.comida;
    var tieneBebida = !!p.bebida;

    if (tieneComida && tieneBebida) {
      pedidos.push({ dia: dia.nombre, comida: p.comida, bebida: p.bebida });
      continue;
    }

    if (!tieneComida && !tieneBebida) {
      diasSinPedido.push(dia.nombre);
      continue;
    }

    if (tieneComida && !tieneBebida) {
      toast('‚ö†Ô∏è ' + dia.nombre + ': eleg√≠ bebida o dej√° el d√≠a sin pedido');
      return;
    }

    toast('‚ö†Ô∏è ' + dia.nombre + ': eleg√≠ comida o dej√° el d√≠a sin pedido');
    return;
  }

  if (pedidos.length === 0) {
    toast('‚ö†Ô∏è Seleccion√° al menos un d√≠a para pedir men√∫');
    return;
  }

  var entrada = {
    nombre: nombre,
    grupo: grupoSeleccionado,
    pedidos: pedidos,
    hora: new Date().toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'}),
    menu_id: menuActivo.id
  };

  envioEnCurso = true;
  if (btnEnviar) {
    btnEnviar.disabled = true;
    btnEnviar.textContent = 'Enviando...';
  }

  try {
    var ok = await saveRespuesta(entrada);
    if (!ok) { toast('‚ùå Error al enviar el pedido'); return; }

    var resumen = pedidos.map(function(p) { return p.dia + ': ' + p.comida + ' + ' + p.bebida; }).join('\n');
    var sinPedido = diasSinPedido.length ? '\nSin pedido: ' + diasSinPedido.join(', ') : '';
    document.getElementById('ya-respondio-detalle').textContent =
      grupoSeleccionado + ' ¬∑ ' + nombre + '\n' + resumen + sinPedido;
    document.getElementById('ya-respondio').classList.add('visible');
    document.getElementById('btn-enviar').style.display = 'none';
    toast('‚úÖ Pedido confirmado');
    envioExitoso = true;
  } finally {
    envioEnCurso = false;
    if (btnEnviar && !envioExitoso) {
      btnEnviar.disabled = false;
      btnEnviar.textContent = textoBotonOriginal;
    }
  }
}

var resumenDiaActivo = 0;
var resumenRespuestas = [];
var resumenFiltroEquipo = '__TODOS__';

function escapeCSV(valor) {
  var s = String(valor == null ? '' : valor);
  return '"' + s.replace(/"/g, '""') + '"';
}

function descargarCSV(nombreArchivo, contenido) {
  var blob = new Blob(["\uFEFF" + contenido], { type: 'text/csv;charset=utf-8;' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = nombreArchivo;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function normalizarNombreArchivo(v) {
  return String(v || '')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-zA-Z0-9_-]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '')
    .toLowerCase();
}

function onChangeResumenFiltroEquipo() {
  var select = document.getElementById('resumen-filtro-equipo');
  resumenFiltroEquipo = select ? select.value : '__TODOS__';
  renderResumenDia();
}

function actualizarOpcionesFiltroResumen() {
  var select = document.getElementById('resumen-filtro-equipo');
  if (!select) return;

  var opciones = ['__TODOS__'].concat(GRUPOS.slice());
  var extras = {};
  for (var i = 0; i < resumenRespuestas.length; i++) {
    var g = String((resumenRespuestas[i] && resumenRespuestas[i].grupo) || '').trim();
    if (g && opciones.indexOf(g) === -1) extras[g] = true;
  }
  Object.keys(extras).sort().forEach(function(g) { opciones.push(g); });

  select.innerHTML = '';
  for (var j = 0; j < opciones.length; j++) {
    var val = opciones[j];
    var opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val === '__TODOS__' ? 'Todos los equipos' : val;
    select.appendChild(opt);
  }

  if (opciones.indexOf(resumenFiltroEquipo) === -1) resumenFiltroEquipo = '__TODOS__';
  select.value = resumenFiltroEquipo;
}

function exportarResumenCSV() {
  if (!menuActivo) { toast('‚ö†Ô∏è No hay men√∫ activo'); return; }
  if (!resumenRespuestas || resumenRespuestas.length === 0) { toast('‚ö†Ô∏è No hay pedidos para exportar'); return; }

  var filas = [];
  for (var i = 0; i < resumenRespuestas.length; i++) {
    var r = resumenRespuestas[i] || {};
    var grupo = String(r.grupo || '').trim();
    if (resumenFiltroEquipo !== '__TODOS__' && grupo !== resumenFiltroEquipo) continue;

    var pedidos = Array.isArray(r.pedidos) ? r.pedidos : [];
    for (var j = 0; j < pedidos.length; j++) {
      var p = pedidos[j] || {};
      filas.push([
        menuActivo.id,
        menuActivo.desde,
        menuActivo.hasta,
        grupo,
        r.nombre || '',
        p.dia || '',
        p.comida || '',
        p.bebida || '',
        r.hora || ''
      ]);
    }
  }

  if (filas.length === 0) { toast('‚ö†Ô∏è No hay pedidos para el filtro seleccionado'); return; }

  var headers = ['menu_id', 'semana_desde', 'semana_hasta', 'equipo', 'nombre', 'dia', 'comida', 'bebida', 'hora'];
  var csv = headers.map(escapeCSV).join(',') + '\n';
  csv += filas.map(function(f) { return f.map(escapeCSV).join(','); }).join('\n');

  var filtro = resumenFiltroEquipo === '__TODOS__' ? 'todos' : normalizarNombreArchivo(resumenFiltroEquipo);
  var archivo = 'resumen-menu-' + normalizarNombreArchivo(menuActivo.desde) + '-a-' + normalizarNombreArchivo(menuActivo.hasta) + '-' + filtro + '.csv';
  descargarCSV(archivo, csv);
  toast('‚úÖ CSV exportado');
}

async function cerrarSemana() {
  if (!menuActivo) { toast('‚ö†Ô∏è No hay men√∫ activo'); return; }
  var tieneCierre = await detectarSoporteCierreMenu(true);
  if (!confirm('Cerrar semana bloquear√° nuevos pedidos, sin borrar el historial. ¬øContinuar?')) return;

  if (!tieneCierre) {
    var okFallback = await saveMenuMetaFallback(menuActivo.id, menuActivo.fecha_limite || null, true);
    if (!okFallback) { toast('‚ùå No se pudo cerrar la semana (fallback)'); return; }
    menuActivo.cerrado = true;
    await cargarResumen();
    toast('üîí Semana cerrada (modo fallback).');
    return;
  }

  const { data, error } = await db
    .from('menu')
    .update({ cerrado: true })
    .eq('id', menuActivo.id)
    .select()
    .single();

  if (error) { console.error('Error al cerrar semana:', error); toast('‚ùå No se pudo cerrar la semana'); return; }
  menuActivo = data;
  await cargarResumen();
  toast('üîí Semana cerrada. Ahora pod√©s exportar CSV y cargar la pr√≥xima.');
}

async function cargarResumen() {
  const menu = await getMenu();
  resumenRespuestas = menu ? await getRespuestas(menu.id) : [];

  if (!menu) {
    document.getElementById('resumen-semana-titulo').textContent = 'No hay men√∫ configurado';
    document.getElementById('stat-total').textContent = '‚Äî';
    document.getElementById('resumen-sin-datos').style.display = 'block';
    document.getElementById('resumen-datos').style.display = 'none';
    return;
  }

  var estado = menuEstaCerrado(menu) ? 'Cerrado' : 'Abierto';
  var limiteTxt = '';
  if (menu.fecha_limite) {
    var limiteFecha = new Date(menu.fecha_limite);
    if (!isNaN(limiteFecha.getTime())) limiteTxt = ' ¬∑ L√≠mite: ' + limiteFecha.toLocaleString('es-AR');
  }
  document.getElementById('resumen-semana-titulo').textContent =
    `Semana del ${formatarFechaCorta(menu.desde)} al ${formatarFechaCorta(menu.hasta)} ¬∑ Estado: ${estado}${limiteTxt}`;
  document.getElementById('stat-total').textContent = resumenRespuestas.length;

  if (resumenRespuestas.length === 0) {
    document.getElementById('resumen-sin-datos').style.display = 'block';
    document.getElementById('resumen-datos').style.display = 'none';
    return;
  }

  document.getElementById('resumen-sin-datos').style.display = 'none';
  document.getElementById('resumen-datos').style.display = 'block';
  actualizarOpcionesFiltroResumen();

  // Tabs de d√≠as
  const tabsEl = document.getElementById('resumen-dia-tabs');
  tabsEl.innerHTML = '';
  menu.dias.forEach((dia, i) => {
    const tab = document.createElement('button');
    tab.className = 'dia-tab' + (i === resumenDiaActivo ? ' activo' : '');
    tab.textContent = getEtiquetaDia(dia.nombre, menu.desde, i);
    tab.onclick = () => { resumenDiaActivo = i; renderResumenDia(); };
    tabsEl.appendChild(tab);
  });

  renderResumenDia();
}

function renderResumenDia() {
  const menu = menuActivo;
  if (!menu || !menu.dias[resumenDiaActivo]) return;

  const dia = menu.dias[resumenDiaActivo];
  const diaName = dia.nombre;

  // Actualizar tabs activo
  document.querySelectorAll('#resumen-dia-tabs .dia-tab').forEach((t, i) => {
    t.classList.toggle('activo', i === resumenDiaActivo);
  });

  // Postre
  if (dia.postre) {
    document.getElementById('resumen-postre').style.display = 'block';
    document.getElementById('resumen-postre-texto').textContent = dia.postre;
  } else {
    document.getElementById('resumen-postre').style.display = 'none';
  }

  // Extraer pedidos del d√≠a seleccionado
  const pedidosDelDia = [];
  resumenRespuestas.forEach(r => {
    if (r.pedidos) {
      const p = r.pedidos.find(p => p.dia === diaName);
      if (p) {
        if (resumenFiltroEquipo !== '__TODOS__' && r.grupo !== resumenFiltroEquipo) return;
        pedidosDelDia.push({ nombre: r.nombre, grupo: r.grupo, comida: p.comida, bebida: p.bebida });
      }
    }
  });

  // Agrupar por equipo
  const porEquipo = {};
  GRUPOS.forEach(g => porEquipo[g] = []);
  pedidosDelDia.forEach(p => {
    const g = p.grupo || 'Sin grupo';
    if (!porEquipo[g]) porEquipo[g] = [];
    porEquipo[g].push(p);
  });

  // Mantener el orden de GRUPOS y agregar al final equipos no previstos.
  const gruposOrdenados = [...GRUPOS];
  Object.keys(porEquipo).forEach(g => {
    if (gruposOrdenados.indexOf(g) === -1) gruposOrdenados.push(g);
  });

  // Renderizar cards por equipo
  let html = '';
  gruposOrdenados.forEach(grupo => {
    const personas = porEquipo[grupo];
    if (!personas || personas.length === 0) return;

    // Subtotales comida
    const contComida = {};
    personas.forEach(p => { contComida[p.comida] = (contComida[p.comida] || 0) + 1; });
    const listaComida = Object.entries(contComida).sort((a,b) => b[1]-a[1])
      .map(([nombre, cant]) => `<span style="background:var(--yellow-light); color:#92400e; padding:2px 8px; border-radius:10px; font-size:0.75rem; margin:2px; border:1px solid #ffe580">${cant}x ${nombre}</span>`).join(' ');

    // Subtotales bebida
    const contBebida = {};
    personas.forEach(p => { contBebida[p.bebida] = (contBebida[p.bebida] || 0) + 1; });
    const listaBebida = Object.entries(contBebida).sort((a,b) => b[1]-a[1])
      .map(([nombre, cant]) => `<span style="background:var(--primary-light); color:var(--primary); padding:2px 8px; border-radius:10px; font-size:0.75rem; margin:2px; border:1px solid #fca5a5">${cant}x ${nombre}</span>`).join(' ');

    // Lista de personas
    const listaPersonas = personas.map(r => `
      <div class="persona-row">
        <div class="persona-avatar">${r.nombre.charAt(0).toUpperCase()}</div>
        <div style="flex:1">
          <div class="persona-nombre">${r.nombre}</div>
        </div>
        <div class="persona-detalle">${r.comida}<br>${r.bebida}</div>
      </div>`).join('');

    html += `
      <div class="card" style="margin-bottom:1rem">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem">
          <h3 style="margin:0; font-size:1rem">${grupo}</h3>
          <span style="background:var(--yellow); color:#2d2d2d; padding:2px 10px; border-radius:10px; font-size:0.75rem; font-weight:600">${personas.length} persona${personas.length > 1 ? 's' : ''}</span>
        </div>
        <div style="margin-bottom:0.5rem">
          <div style="font-size:0.7rem; color:var(--muted); margin-bottom:4px">üçõ Comidas</div>
          <div style="display:flex; flex-wrap:wrap; gap:2px">${listaComida}</div>
        </div>
        <div style="margin-bottom:0.75rem">
          <div style="font-size:0.7rem; color:var(--muted); margin-bottom:4px">ü•§ Bebidas</div>
          <div style="display:flex; flex-wrap:wrap; gap:2px">${listaBebida}</div>
        </div>
        <div>${listaPersonas}</div>
      </div>`;
  });

  if (!html) {
    html = '<div class="card" style="text-align:center; color:var(--muted)">No hay pedidos para este d√≠a con el filtro actual</div>';
  }

  document.getElementById('resumen-equipos').innerHTML = html;
}

async function resetearRespuestas() {
  await cerrarSemana();
}

// ========== INIT ==========
async function cargarMenuEnAdmin() {
  const menu = await getMenu();
  if (menu && menu.dias) {
    var porNombre = {};
    menu.dias.forEach(d => { porNombre[d.nombre] = d; });
    menuDias = DIAS.map(nombre => {
      var d = porNombre[nombre] || {};
      return {
        nombre: nombre,
        comidas: Array.isArray(d.comidas) ? [...d.comidas] : [],
        bebidas: getBebidasFijas(),
        postre: d.postre || ''
      };
    });
    document.getElementById('semana-desde').value = toDateValue(menu.desde);
    document.getElementById('semana-hasta').value = toDateValue(menu.hasta);
    document.getElementById('semana-fecha-limite').value = toDateTimeLocalValue(menu.fecha_limite);
    const link = window.location.href.split('?')[0] + '?vista=form';
    document.getElementById('link-texto').textContent = link;
    document.getElementById('link-generado').style.display = 'block';
  } else {
    document.getElementById('semana-fecha-limite').value = '';
  }
  renderAdminTabs();
}

async function init() {
  const params = new URLSearchParams(window.location.search);
  await detectarSoporteCierreMenu();

  // Empleados: solo ven el formulario
  if (params.get('vista') === 'form') {
    document.getElementById('tab-admin').style.display = 'none';
    document.getElementById('tab-resumen').style.display = 'none';
    document.getElementById('tab-login').style.display = 'none';
    irA('form');
    return;
  }

  // Admin: mostrar login
  document.getElementById('tab-login').style.display = '';
  irA('login');
}

init();
</script>
</body>
</html>
